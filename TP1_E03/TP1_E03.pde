/* ANI-2021 - Programmation en animation
 * Hiver 2022
 * Travail pratique 1
 * Équipe 3 composée de :
   * Alexandre Doucet-Lagueux
   * Christophe Chalifour-Perutin
   * Julie Charbonneau
   * Maïlys Gaudin
   * Olivier Desmarais
 */
 
//Importations
import processing.sound.*;

//Tests
float testX = 2 * 1020 / 3;
float testY = 500;

//Strcture canevas
final int dimensionX = 1020;
final int dimensionY = 720;

//Références
int centreX, centreY;
boolean pressed;

//Structure du jeu
boolean debut, jeu, fin;

//Début du jeu
Bouton bCommencer;

//Fin du jeu
boolean termine;
boolean victoire;
PImage imgCanevas;
final int objectif = 5;
Bouton bRejouer;
final int dimensionCadreFin = 400;
SoundFile sonVictoire;
SoundFile sonDefaite;

//Environnement
PImage imgAccueil;
PImage cielJour, cielNuit;
PImage cockpit;
final int hauteurCockpit = 242;

//Toggle jour/nuit
boolean isJour;
Slider sliderJourNuit;

//Étoiles
boolean besoinEtoiles;
ArrayList<Etoile> listeEtoiles;
final float frequenceEtoiles = 1.0f;
float delaiEtoiles;
SoundFile sonEtoile;
PImage[] etoilesRef;
final int diametreAttraperEtoile = 50;


//Ennemis
ArrayList<Ennemi> listeEnnemis;
float delaiEnnemis;
final float frequenceEnnemis = 2.0f;
PImage[] imgEnnemis;
PImage[] masqueEnnemis;
SoundFile sonEnnemi;

//Attaque
final float diametreAttaqueMax = 150;
int nbKills;

//Jauge magie
Jauge jaugeMagie;
SoundFile sonManqueMagie;


//Gestion du temps
float tempsEcoule, tempsCourant;

//Musique
SinOsc musique;
Env enveloppeMusique;
final int[] notesMusique = {440, 494, 554, 494, 440, 494, 554, 494,
                            415, 440, 494, 440, 415, 440, 494, 440,
                            370, 415, 440, 415, 370, 415, 440, 415,
                            415, 440, 494, 440, 415, 440, 494, 440}; 
int idxNote;
float delaiMusique;
float frequenceMusique;
float delaiNote;
final float longueurNote = 0.1f;
boolean musiqueOn;

void settings() {
  size( dimensionX, dimensionY);
}

void setup() {
  
  frameRate(30);
  pressed = false;
  
  centreX = width / 2;
  centreY = height / 2;
  
  //Structure du jeu
  debut = true;
  jeu = false;
  fin = false;
  
  //Début du jeu
  bCommencer = new Bouton (centreX, centreY, 160, 90, color(255), color(0), "Commencer");
  
  //Fin du jeu
  termine = false;
  imgCanevas = createImage(dimensionX, dimensionY, RGB);
  bRejouer = new Bouton (centreX, centreY + dimensionCadreFin / 3, 200, 50, color(200), color(0), "Rejouer");
  sonVictoire = new SoundFile(this, "victoire.aiff");
  sonDefaite = new SoundFile(this, "sonDefaite.wav");
  
  //Environnement
  imgAccueil = loadImage("ACCEUIL.png");
  cielJour = loadImage("CIEL_JOUR.png");
  cielNuit = loadImage("CIEL_NUIT.png");
  cockpit = loadImage("CABINE_M2.png");
  
  //Slider jour-nuit
  sliderJourNuit = new Slider(698.0f, 547.0f);
  
  //Étoiles
  sonEtoile = new SoundFile(this, "sonEtoileMono.mp3");
  sonEtoile.amp(0.1f);
  etoilesRef = new PImage[3];
  etoilesRef[0] = loadImage("ETOILE_GRANDE.png");
  etoilesRef[1] = loadImage("ETOILE_PETITE.png");
  etoilesRef[2] = loadImage("ETOILE_RONDE.png");
  
  //Ennemis
  //imgEnnemi = loadImage("ennemi/alien01.png");
  genererImageEnnemi();
  sonEnnemi = new SoundFile(this, "Grunt2.wav");
  
  //Jauge pouvoir
  jaugeMagie = new Jauge(283, 518, 181, 30, 100, 1.0f, color(255, 255, 0, 255));
  sonManqueMagie = new SoundFile(this, "SonManqueMagie.wav");
  sonManqueMagie.amp(0.1f); 
    
  //Musique
  musique = new SinOsc(this);
  enveloppeMusique = new Env(this);
  musique.amp(0.2f);
  idxNote = 0;
  musiqueOn = true;
}

void draw() {
  //Écran d'accueil
  if (debut) {
    afficherAccueil();
    
    /*//Test
    //int idx = 0;
    image(imgEnnemis[0], 0, 0);
    image(imgEnnemis[1], centreX, 0);
    image(imgEnnemis[2], 0, centreY);
    image(imgEnnemis[3], centreX, centreY);
    //idx = (idx == 6) ? idx : 0;*/
  }
  
  //Déroulement du jeu
  if(jeu) {
    //tint(255, 255);
    
    //Écran principal
    afficherJeu();

    //Gestion du temps
    tempsEcoule = (millis() - tempsCourant) / 1000.0f;
    delaiEtoiles += tempsEcoule;
    delaiEnnemis += tempsEcoule;
    delaiMusique += tempsEcoule;
    tempsCourant = millis();
    
    //Slider jour-nuit
    sliderJourNuit.update();
    
    //Jauge magie
    jaugeMagie.update();
    
    //Étoiles
    if (delaiEtoiles > frequenceEtoiles) {
      ajouterEtoile();
      delaiEtoiles -= frequenceEtoiles;
    }
    if (!isJour && pressed) {
      attraperEtoiles();
    }
      
    //Ennemis
    if (delaiEnnemis > frequenceEnnemis) {
      ajouterEnnemi();
      delaiEnnemis -= frequenceEnnemis;
    }
    updateEnnemis();
      
    //Jouer la musique
    frequenceMusique = map(listeEnnemis.size(), 0, objectif, 0.2f, 0.1f);
    if (delaiMusique > frequenceMusique) {
      if (musiqueOn)
        jouerMusique();
      delaiMusique -= frequenceMusique;
    }
    
    //Fin du jeu
    if (nbKills >= objectif || listeEnnemis.size() >= objectif) {
      termine = true;
      if (nbKills >= objectif) {
        victoire = true;
        sonVictoire.play();
      } else {
        victoire = false;
        sonDefaite.play();
      }
    }
    if (termine) {
      transitionFin();
    }
  }

  
  //Écran de fin
  if (fin) {
    afficherFin();
  }
}

void mousePressed() {
  pressed = true;
}

void mouseReleased() {
  //Pendant le jeu
  if (jeu){
    if (isJour) {
      if(mouseY < height - hauteurCockpit) {
        if (jaugeMagie.niveau >= 10)
          attaquer();
        else
          sonManqueMagie.play();
      }
    }
  }
  
  //Écran d'accueil
  if (debut) {
    if (bCommencer.verifierSuperposition()) {
      clicCommencer();
      /*initialisation();
      jeu = true;
      debut = false;*/
    }
  }

  //Écran fin
  if (fin) {
    if (bRejouer.verifierSuperposition()) {
      clicRejouer();
      /*initialisation();
      fin = false;
      jeu = true;*/
    }
  }
  
  if(pressed)
    pressed = false;
}

void keyReleased() {
  //Slider jour-nuit
  if (key == ' ') {
    if (isJour)
      sliderJourNuit.deplacement('n');
    else
      sliderJourNuit.deplacement('j');
  }
  
  //Musique
  if (key == 'm')
    musiqueOn = !musiqueOn;
  
  //Activer bouton
  if (keyCode == ENTER) {
    if (debut)
      clicCommencer();
    if (fin)
      clicRejouer();
  }
}

void initialisation() {
  
  //Toggle jour-nuit 
  isJour = true;
  
  //Étoiles
  listerEtoiles();
  delaiEtoiles = 0.0f;
  
  //Ennemis
  listerEnnemis();
  delaiEnnemis = 0.0f;
  
  //Jauge pouvoir
  jaugeMagie.niveau = 100;
  jaugeMagie.niveauCourant = 100;
  nbKills = 0;
 
  //Gestion du temps
  tempsEcoule = 0.0f;
  tempsCourant = 0.0f;
  tempsCourant = millis();
  
  //Musique
  idxNote = 0;
  jouerMusique();  
}

void afficherAccueil() {
  //background(180);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  imageMode(CORNER);
  image(imgAccueil, 0, 0);

  //Bouton pour commencer
  bCommencer.render();
}

void afficherJeu() {
  imageMode(CORNER);
  //tint(255, 255);
  
  if(isJour) {
    image(cielJour, 0, 0);
    afficherEnnemis();
  } else {
    image(cielNuit, 0, 0);
    afficherEtoiles();
  } 
  afficherCockpit();
}

void afficherFin() {
  //tint(255, 255);
  
  //Cadre
  rectMode(CENTER);
  stroke(130);
  strokeWeight(10);
  fill(255);
  rect(centreX, centreY, dimensionCadreFin, dimensionCadreFin);
  
  //Texte
  fill(0);
  if (victoire) {
    text("Victoire !!!", centreX, centreY - dimensionCadreFin / 3);
  } else {
    text("Vous n'avez pas pu prévenir l'invasion ...", centreX, centreY - dimensionCadreFin / 3);
  }
  text("Nombre de kills : " + nbKills + "\n Nombre d'ennemis : " + listeEnnemis.size(), centreX, centreY);
  
  //Bouton rejouer
  bRejouer.render();
}

void teinteEcran(color couleur) {
    PImage ecran = get (0, 0, dimensionX, dimensionY);
    tint(couleur);
    imageMode(CORNER);
    image(ecran, 0, 0);
    tint(255, 255);
}

void afficherCockpit() {
  //Fond
  imageMode(CORNER);
  image(cockpit, 0, 0);

  //Outils
  fill(255, 0, 0);
  text(listeEnnemis.size(), 540, 579);
  sliderJourNuit.render();
  jaugeMagie.render();
}

void listerEtoiles() {
  int nbEtoiles = int(random(1, 10));
  listeEtoiles = new ArrayList<Etoile>();

  for (int idx = 0; idx < nbEtoiles ; idx++) {
    Etoile etoile = new Etoile();
    listeEtoiles.add(etoile);
  }
}

void afficherEtoiles() { 
  for (int idx = 0; idx < listeEtoiles.size() ; idx++) {
    listeEtoiles.get(idx).render();
  }
}

void ajouterEtoile() {
  if (listeEtoiles.size() < 20) {
    Etoile etoile = new Etoile();
    listeEtoiles.add(etoile);
  }
}

void attraperEtoiles() {
  //Cercle qui attrape
  fill(255, 100);
  noStroke();
  if (mouseY < height - hauteurCockpit)
    ellipse(mouseX, mouseY, diametreAttraperEtoile, diametreAttraperEtoile);
  
  //Vérifier les contacts
  for (int idx = 0 ; idx < listeEtoiles.size() ; idx++) {    
    if (listeEtoiles.get(idx).verifierSuperposition()) {
      jaugeMagie.niveau += listeEtoiles.get(idx).puissance;
      if (jaugeMagie.niveau > 100)
        jaugeMagie.niveau = 100;
      listeEtoiles.remove(idx);
      if (mouseX >= 0 && mouseX <= dimensionX)
        sonEtoile.pan(map(mouseX, 0, width, -1, 1));
      else if (mouseX < 0)
        sonEtoile.pan(-1);
      else
        sonEtoile.pan(1);
      sonEtoile.play();
    }
  }
}

void genererImageEnnemi() {
  String emplaImage = "ennemi/alien";
  String emplaMasque = "ennemi/masque";
  
  imgEnnemis = new PImage[7]; 
  masqueEnnemis = new PImage[7];
  
  PImage image;
  //PImage masque;
  
  for (int idx = 0 ; idx < 7 ; idx++) {
    //int idxImg = idx + 1;
    
    image = loadImage(emplaImage + nf(idx + 1, 2) + ".png");
    masqueEnnemis[idx] = loadImage(emplaMasque + nf(idx + 1, 2) + ".png");
    
    imgEnnemis[idx] = createImage(400, 400, ARGB);
    
    //imgEnnemis.copy(image.mask(masque));
    
    //image.mask(masque);
    imgEnnemis[idx] = image;
    imgEnnemis[idx].mask(masqueEnnemis[idx]);
    
    //image(image, centreX, centreY);
    
    //imgEnnemis[idx] = loadImage(emplaImage + idxImg + ".png");
    //imgEnnemis[idx].mask(masque);
  }
}

void listerEnnemis() {
  int nbEnnemis = int(random(1, 4));
  listeEnnemis = new ArrayList<Ennemi>();

  for (int idx = 0; idx < nbEnnemis ; idx++) {
    Ennemi ennemi = new Ennemi();
    listeEnnemis.add(ennemi);
  }
}

void afficherEnnemis() { 
  for (int idx = 0; idx < listeEnnemis.size() ; idx++) {
    listeEnnemis.get(idx).render();
  }
}

void ajouterEnnemi() {
  //Ajout à la liste
  Ennemi ennemi = new Ennemi();
  listeEnnemis.add(ennemi);

  //Feedback
  teinteEcran(color(255, 0, 0, 255));
}

void updateEnnemis() {
  for (int idx = 0 ; idx < listeEnnemis.size() ; idx++) {
    listeEnnemis.get(idx).jaugeVie.update();
    if (listeEnnemis.get(idx).jaugeVie.niveauCourant <= 0) {
      sonEnnemi.play();
      listeEnnemis.remove(idx);
      nbKills++;
    }
  }
}

void attaquer() {
  //Emplacement de l'attaque
  PVector position = new PVector(mouseX, mouseY);
  
  //Visuel
  ellipseMode(CENTER);
  noStroke();
  float diametre = 25.0f;
  float opacite = 255.0f;
  while (diametre < diametreAttaqueMax) {
    fill(255, opacite);
    ellipse(position.x, position.y, diametre, diametre);
    diametre += 25;
    opacite -= 50;
  }
  
  //Jauge magie
  jaugeMagie.niveau -= 10;
  
  //Vérifier les contacts
  for (int idx = 0 ; idx < listeEnnemis.size(); idx++)
    listeEnnemis.get(idx).verifierDegats(position.x, position.y);
}

void jouerMusique() {
  //Jouer la musique
  musique.freq(notesMusique[idxNote]);
  musique.play();
  enveloppeMusique.play(musique, 0.01f, 0.004f, 0.3f, 0.4f);
  
  //Index de la prochaine note
  if (idxNote < notesMusique.length - 1)
    idxNote++;
  else
    idxNote = 0;
}

void transitionFin() {
  musique.stop();
  teinteEcran(color(255, 255, 255));
  imgCanevas = get(0, 0, dimensionX, dimensionY);
  termine = false;
  jeu = false;
  fin = true;
  
  //Afficher fond
  imageMode(CORNER);
  imgCanevas.filter(BLUR, 10);
  image(imgCanevas, 0, 0);
}

void clicCommencer() {
  initialisation();
  jeu = true;
  debut = false;
}

void clicRejouer() {
  initialisation();
  fin = false;
  jeu = true;
}
